flowchart TD
    Start(["Every 5 Minutes"]) --> GetSKU["Get Current SKU<br/>F512 / F1024 / F2048"]
    GetSKU --> GetMetrics["Get Metrics from Power BI<br/>(filtered by Capacity ID)"]
    GetMetrics --> ParseMetrics["Parse: CU%, Avg45Min,<br/>ThrottleCount, RejectionPct"]
    ParseMetrics --> Emergency{"Emergency?<br/>CU‚â•95% OR<br/>Throttle>0 OR<br/>Reject‚â•0.5%"}

    Emergency -->|Yes| CheckQuota{"Can Scale Up?<br/>(Quota Check)"}
    CheckQuota -->|Yes| EmergencyScale["üö® EMERGENCY SCALE UP<br/>(Bypass Cooldown)"]
    CheckQuota -->|No/Fail| QuotaBlocked["‚ö†Ô∏è Scale Blocked<br/>(Quota Limit)"]
    Emergency -->|No| Cooldown{"Cooldown<br/>Active?"}

    Cooldown -->|Yes, < 30min| LogCooldown["Log: Cooldown Active"]
    Cooldown -->|No| CheckScaleUp{"Scale Up<br/>Needed?"}

    CheckScaleUp -->|Yes| ScaleUp["‚¨ÜÔ∏è Scale Up<br/>F512‚ÜíF1024‚ÜíF2048"]
    CheckScaleUp -->|No| CheckScaleDown{"Scale Down<br/>Needed?"}

    CheckScaleDown -->|Yes| ScaleDown["‚¨áÔ∏è Scale Down<br/>F2048‚ÜíF1024‚ÜíF512"]
    CheckScaleDown -->|No| NoAction["‚úì No Action Needed"]

    EmergencyScale --> Notify["üìß Send Email"]
    QuotaBlocked --> NotifyBlocked["üìß Send Blocked Email"]
    ScaleUp --> Notify
    ScaleDown --> Notify
    LogCooldown --> Log["üìù Log to App Insights"]
    NoAction --> Log
    Notify --> Log
    NotifyBlocked --> Log

    style Emergency fill:#ffcdd2
    style EmergencyScale fill:#ef5350,color:#fff
    style QuotaBlocked fill:#ffc107,color:#000
    style CheckQuota fill:#fff9c4
    style ScaleUp fill:#81c784
    style ScaleDown fill:#fff176
    style NoAction fill:#e0e0e0
